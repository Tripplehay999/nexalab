<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Client Portal — NexaLab</title>
  <meta name="robots" content="noindex" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="bg-grid" aria-hidden="true"></div>

  <div class="auth-wrap">
    <div class="auth-card">

      <!-- Brand -->
      <a href="index.html" class="auth-brand">NexaLab</a>
      <p class="auth-portal-label">Client Portal</p>

      <!-- Tabs -->
      <div class="auth-tabs" role="tablist">
        <button class="auth-tab is-active" id="tab-signin" role="tab" aria-selected="true"  data-auth-tab="signin">Sign in</button>
        <button class="auth-tab"            id="tab-signup" role="tab" aria-selected="false" data-auth-tab="signup">Create account</button>
      </div>

      <!-- ── Social login ─────────────────────────────────── -->
      <div id="social-section">
        <div class="auth-social-btns">
          <button class="auth-social-btn" id="google-btn" type="button">
            <svg width="18" height="18" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
              <path d="M43.6 20.1H42V20H24v8h11.3C33.7 32.7 29.2 36 24 36c-6.6 0-12-5.4-12-12s5.4-12 12-12c3.1 0 5.8 1.2 8 3l5.7-5.7C34 6.1 29.3 4 24 4 13 4 4 13 4 24s9 20 20 20 20-9 20-20c0-1.3-.1-2.7-.4-3.9z" fill="#FFC107"/>
              <path d="M6.3 14.7l6.6 4.8C14.7 15.1 19 12 24 12c3.1 0 5.8 1.2 8 3l5.7-5.7C34 6.1 29.3 4 24 4 16.3 4 9.7 8.3 6.3 14.7z" fill="#FF3D00"/>
              <path d="M24 44c5.2 0 9.9-2 13.4-5.2l-6.2-5.2A12 12 0 0 1 24 36c-5.2 0-9.6-3.3-11.3-7.9l-6.5 5C9.5 39.6 16.2 44 24 44z" fill="#4CAF50"/>
              <path d="M43.6 20.1H42V20H24v8h11.3a12 12 0 0 1-4.1 5.6l6.2 5.2C37 39.2 44 34 44 24c0-1.3-.1-2.7-.4-3.9z" fill="#1976D2"/>
            </svg>
            Continue with Google
          </button>
          <button class="auth-social-btn" id="github-btn" type="button">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0 1 12 6.844a9.59 9.59 0 0 1 2.504.337c1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.02 10.02 0 0 0 22 12.017C22 6.484 17.522 2 12 2z"/>
            </svg>
            Continue with GitHub
          </button>
        </div>
        <div class="auth-divider"><span>or continue with email</span></div>
      </div>

      <!-- ── Sign In ──────────────────────────────────────── -->
      <form id="signin-form" class="auth-form" novalidate>
        <label class="auth-field">
          Email address
          <input id="si-email" name="email" type="email" placeholder="you@brand.com" autocomplete="email" required />
        </label>
        <label class="auth-field">
          Password
          <input id="si-password" name="password" type="password" placeholder="••••••••" autocomplete="current-password" required />
        </label>
        <div class="auth-row">
          <button type="button" class="auth-link" id="forgot-btn">Forgot password?</button>
        </div>
        <p class="auth-error" id="si-error" aria-live="polite"></p>
        <button class="btn btn-primary auth-submit" type="submit" id="si-submit">
          <span id="si-label">Sign in</span>
          <svg id="si-spinner" class="spinner" width="16" height="16" viewBox="0 0 24 24" fill="none" hidden><circle cx="12" cy="12" r="10" stroke="rgba(255,255,255,0.25)" stroke-width="2.5"/><path d="M12 2a10 10 0 0 1 10 10" stroke="#fff" stroke-width="2.5" stroke-linecap="round"/></svg>
        </button>
        <p class="auth-footer-note">Access is invite-only. <a href="contact.html" class="auth-link">Book a demo</a> to get started.</p>
      </form>

      <!-- ── Sign Up ──────────────────────────────────────── -->
      <form id="signup-form" class="auth-form" hidden novalidate>
        <div class="auth-grid-2">
          <label class="auth-field">
            First name *
            <input id="su-fname" name="firstName" type="text" placeholder="Jane" autocomplete="given-name" required />
          </label>
          <label class="auth-field">
            Last name *
            <input id="su-lname" name="lastName" type="text" placeholder="Smith" autocomplete="family-name" required />
          </label>
        </div>
        <label class="auth-field">
          Company / brand name
          <input id="su-company" name="company" type="text" placeholder="Acme Inc." autocomplete="organization" />
        </label>
        <label class="auth-field">
          Work email *
          <input id="su-email" name="email" type="email" placeholder="you@brand.com" autocomplete="email" required />
        </label>
        <label class="auth-field">
          Password * <span class="auth-field-hint">(min 8 characters)</span>
          <input id="su-password" name="password" type="password" placeholder="••••••••" autocomplete="new-password" required minlength="8" />
        </label>
        <label class="auth-field">
          Confirm password *
          <input id="su-confirm" name="confirm" type="password" placeholder="••••••••" autocomplete="new-password" required />
        </label>
        <p class="auth-error" id="su-error" aria-live="polite"></p>
        <button class="btn btn-primary auth-submit" type="submit" id="su-submit">
          <span id="su-label">Create account</span>
          <svg id="su-spinner" class="spinner" width="16" height="16" viewBox="0 0 24 24" fill="none" hidden><circle cx="12" cy="12" r="10" stroke="rgba(255,255,255,0.25)" stroke-width="2.5"/><path d="M12 2a10 10 0 0 1 10 10" stroke="#fff" stroke-width="2.5" stroke-linecap="round"/></svg>
        </button>
        <p class="auth-footer-note">By creating an account you agree to NexaLab's terms of service.</p>
      </form>

      <!-- ── Check email message ─────────────────────────── -->
      <div id="check-email-panel" hidden>
        <div class="auth-success-icon">
          <svg width="26" height="26" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="10" stroke="#22d3a8" stroke-width="1.5"/><path d="M7 12l4 4 6-7" stroke="#22d3a8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </div>
        <h3 class="auth-success-title" id="check-email-title">Check your inbox</h3>
        <p class="auth-success-body" id="check-email-body">We've sent a confirmation link to your email. Click it to activate your account and get access to the client portal.</p>
        <button class="btn btn-outline auth-submit" style="margin-top:1.2rem;" onclick="location.reload()">Back to sign in</button>
      </div>

      <!-- ── Reset password message ──────────────────────── -->
      <div id="reset-email-panel" hidden>
        <div class="auth-success-icon">
          <svg width="26" height="26" viewBox="0 0 24 24" fill="none"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z" stroke="#9aa8ff" stroke-width="1.5"/><polyline points="22,6 12,13 2,6" stroke="#9aa8ff" stroke-width="1.5"/></svg>
        </div>
        <h3 class="auth-success-title">Reset link sent</h3>
        <p class="auth-success-body">Check your inbox for a password reset link. It expires in 1 hour.</p>
        <button class="btn btn-outline auth-submit" style="margin-top:1.2rem;" id="reset-back-btn">Back to sign in</button>
      </div>

    </div><!-- /auth-card -->

    <p class="auth-back"><a href="index.html">← Back to NexaLab</a></p>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script src="supabase-config.js"></script>
  <script>
  (async function authPage() {

    // ── Redirect if already logged in (role-aware) ────────
    const { data: { session: existingSession } } = await nexaSupabase.auth.getSession();
    if (existingSession) {
      const { data: p } = await nexaSupabase
        .from('profiles').select('role').eq('id', existingSession.user.id).single();
      window.location.href = p?.role === 'admin' ? 'admin.html' : 'dashboard.html';
      return;
    }

    // ── DOM refs ──────────────────────────────────────────
    const tabs          = document.querySelectorAll('.auth-tab');
    const siForm        = document.getElementById('signin-form');
    const suForm        = document.getElementById('signup-form');
    const socialSection = document.getElementById('social-section');

    function hideSocial() { if (socialSection) socialSection.hidden = true; }
    function showSocial() { if (socialSection) socialSection.hidden = false; }

    // ── Tabs ─────────────────────────────────────────────
    tabs.forEach((tab) => tab.addEventListener('click', () => {
      tabs.forEach((t) => { t.classList.remove('is-active'); t.setAttribute('aria-selected', 'false'); });
      tab.classList.add('is-active');
      tab.setAttribute('aria-selected', 'true');
      const which = tab.dataset.authTab;
      siForm.hidden = (which !== 'signin');
      suForm.hidden = (which !== 'signup');
    }));

    // ── Loading helpers ───────────────────────────────────
    function setLoading(prefix, on) {
      document.getElementById(`${prefix}-submit`).disabled = on;
      document.getElementById(`${prefix}-label`).style.display = on ? 'none' : '';
      document.getElementById(`${prefix}-spinner`).hidden = !on;
    }
    function setError(prefix, msg) {
      document.getElementById(`${prefix}-error`).textContent = msg;
      setLoading(prefix, false);
    }

    // ── Role-aware redirect helper ────────────────────────
    async function redirectToDashboard() {
      const { data: { session } } = await nexaSupabase.auth.getSession();
      const { data: p } = await nexaSupabase
        .from('profiles').select('role').eq('id', session.user.id).single();
      window.location.href = p?.role === 'admin' ? 'admin.html' : 'dashboard.html';
    }

    // ── Social OAuth ──────────────────────────────────────
    async function signInWithProvider(provider) {
      const { error } = await nexaSupabase.auth.signInWithOAuth({
        provider,
        options: { redirectTo: window.location.origin + '/auth.html' },
      });
      if (error) document.getElementById('si-error').textContent = error.message;
    }

    document.getElementById('google-btn').addEventListener('click', () => signInWithProvider('google'));
    document.getElementById('github-btn').addEventListener('click', () => signInWithProvider('github'));

    // ── Sign In ───────────────────────────────────────────
    siForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email    = document.getElementById('si-email').value.trim();
      const password = document.getElementById('si-password').value;
      if (!email || !password) { setError('si', 'Please fill in all fields.'); return; }
      setLoading('si', true);
      document.getElementById('si-error').textContent = '';

      const { error } = await nexaSupabase.auth.signInWithPassword({ email, password });
      if (error) { setError('si', error.message); return; }
      await redirectToDashboard();
    });

    // ── Sign Up ───────────────────────────────────────────
    suForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const firstName = document.getElementById('su-fname').value.trim();
      const lastName  = document.getElementById('su-lname').value.trim();
      const company   = document.getElementById('su-company').value.trim();
      const email     = document.getElementById('su-email').value.trim();
      const password  = document.getElementById('su-password').value;
      const confirm   = document.getElementById('su-confirm').value;

      if (!firstName || !lastName || !email || !password) { setError('su', 'Please fill in all required fields.'); return; }
      if (password.length < 8) { setError('su', 'Password must be at least 8 characters.'); return; }
      if (password !== confirm) { setError('su', 'Passwords do not match.'); return; }
      setLoading('su', true);
      document.getElementById('su-error').textContent = '';

      const { error } = await nexaSupabase.auth.signUp({
        email,
        password,
        options: { data: { full_name: `${firstName} ${lastName}`, company: company || null } },
      });

      if (error) { setError('su', error.message); return; }
      suForm.hidden = true;
      hideSocial();
      document.getElementById('check-email-title').textContent = `Check your inbox, ${firstName}`;
      document.getElementById('check-email-panel').hidden = false;
    });

    // ── Forgot password ───────────────────────────────────
    document.getElementById('forgot-btn').addEventListener('click', async () => {
      const email = document.getElementById('si-email').value.trim();
      if (!email) { setError('si', 'Enter your email above first.'); return; }
      setLoading('si', true);
      const { error } = await nexaSupabase.auth.resetPasswordForEmail(email, {
        redirectTo: window.location.origin + '/auth.html',
      });
      setLoading('si', false);
      if (error) { setError('si', error.message); return; }
      siForm.hidden = true;
      hideSocial();
      document.getElementById('reset-email-panel').hidden = false;
    });

    // ── Reset panel — back to sign in ─────────────────────
    document.getElementById('reset-back-btn').addEventListener('click', () => {
      document.getElementById('reset-email-panel').hidden = true;
      siForm.hidden = false;
      showSocial();
    });

  })();
  </script>
</body>
</html>
